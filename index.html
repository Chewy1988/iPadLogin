<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>iPad Visitor Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#34c759">

<!-- iOS PWA Support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="logo.png">

<style>
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f7; margin: 0; padding: 50px 20px; }
  .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  h1 { text-align: center; font-size: 32px; margin-bottom: 25px; }
  input { width: 100%; font-size: 24px; padding: 18px; border-radius: 12px; border: 1px solid #ccc; margin-bottom: 20px; box-sizing: border-box; }
  .buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
  button { flex: 1; font-size: 24px; padding: 20px; border: none; border-radius: 14px; cursor: pointer; min-width: 120px; }
  .sign-in { background: #34c759; color: white; }
  .sign-out { background: #ff3b30; color: white; }
  h2 { margin-top: 30px; font-size: 24px; }
  ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
  li { background: #f2f2f7; margin: 8px 0; padding: 12px 16px; border-radius: 10px; font-size: 20px; cursor: pointer; }
  li:active { background: #d1d1d6; }
  .footer { margin-top: 30px; text-align: center; }
  .export { font-size: 20px; padding: 14px 20px; border-radius: 12px; background: grey; color: white; border: none; cursor: pointer; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Modal base */
  #confirmModal, #passcodeModal, #exportConfirmModal { display:none; }
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); opacity:0; pointer-events:none; transition: opacity 0.3s ease; }
  .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); background: white; padding: 25px; border-radius: 16px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.25); opacity:0; pointer-events:none; transition: opacity 0.3s ease, transform 0.3s ease; }
  .modal.show, .modal-backdrop.show { opacity: 1; pointer-events: auto; }
  .modal.show { transform: translate(-50%, -50%) scale(1); }
  .modal h3 { font-size: 24px; margin-bottom: 10px; }
  .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
  .modal-buttons button { flex: 1; font-size: 22px; padding: 14px; border-radius: 12px; border: none; cursor: pointer; }
  .modal-buttons .yes { background: #34c759; color: white; }
  .modal-buttons .no { background: #ff3b30; color: white; }
</style>
</head>
<body>

<!-- Modals -->
<div id="confirmModal">
  <div class="modal-backdrop"></div>
  <div class="modal">
    <h3>Induction Confirmation</h3>
    <p>Have you been inducted?</p>
    <div class="modal-buttons">
      <button class="yes" onclick="confirmInduction(true)">Yes</button>
      <button class="no" onclick="confirmInduction(false)">No</button>
    </div>
  </div>
</div>

<div id="passcodeModal">
  <div class="modal-backdrop"></div>
  <div class="modal">
    <h3>Enter Passcode</h3>
    <input type="password" id="passcodeInput" placeholder="Enter passcode" />
    <div class="modal-buttons">
      <button class="yes" onclick="checkPasscode()">Submit</button>
      <button class="no" onclick="closeModal('passcodeModal')">Cancel</button>
    </div>
  </div>
</div>

<div id="exportConfirmModal">
  <div class="modal-backdrop"></div>
  <div class="modal">
    <h3>Confirm Export</h3>
    <p>Did the CSV download successfully?</p>
    <div class="modal-buttons">
      <button class="yes" onclick="confirmExport(true)">Yes</button>
      <button class="no" onclick="confirmExport(false)">No</button>
    </div>
  </div>
</div>

<div class="container">
  <div style="text-align:center; margin-bottom:20px;">
    <img src="logo.png" alt="Company Logo" style="max-width:200px; height:auto;">
  </div>

  <h1>Project Argo CDM Area - Sign In/Out</h1>
  <input id="nameInput" placeholder="Enter your name" />

  <div class="buttons">
    <button class="sign-in" onclick="signIn()">Sign In</button>
    <button class="sign-out" onclick="signOut()">Sign Out</button>
  </div>

  <h2>Currently Signed In</h2>
  <ul id="activeList"></ul>

  <div class="footer">
    <button class="export" onclick="requestExport()">Export to CSV</button>
  </div>
</div>

<script>
/* ------------------- Variables ------------------- */
let visits = JSON.parse(localStorage.getItem("visits")) || [];
const nameInput = document.getElementById("nameInput");
const activeList = document.getElementById("activeList");
let pendingSignInName = null;
let pendingAction = null;
let nameClearTimeout = null;

/* ------------------- Helper Functions ------------------- */
function openModal(id) {
  const modal = document.getElementById(id);
  modal.style.display = "block";
  requestAnimationFrame(() => modal.classList.add("show"));
}

function closeModal(id) {
  const modal = document.getElementById(id);
  modal.classList.remove("show");
  setTimeout(() => { modal.style.display = "none"; }, 300);
}

function formatDate(dateString) {
  const d = new Date(dateString);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const hours = String(d.getHours()).padStart(2, "0");
  const minutes = String(d.getMinutes()).padStart(2, "0");
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

/* ------------------- Sign In / Sign Out ------------------- */
function signIn() {
  const name = nameInput.value.trim();
  if (!name) return alert("Please enter your name");
  if (visits.find(v => v.name === name && !v.signOut)) return alert("You are already signed in");
  pendingSignInName = name;
  openModal("confirmModal");
}

function confirmInduction(confirmed) {
  closeModal("confirmModal");
  if (!confirmed) { pendingSignInName = null; return; }
  visits.push({ name: pendingSignInName, signIn: new Date().toISOString(), signOut: null });
  pendingSignInName = null;
  save();
}

function signOut() {
  const name = nameInput.value.trim();
  const visit = visits.find(v => v.name === name && !v.signOut);
  if (!visit) return alert("You are not currently signed in");
  visit.signOut = new Date().toISOString();
  save();
}

function save() {
  localStorage.setItem("visits", JSON.stringify(visits));
  nameInput.value = "";
  render();
}

function render() {
  activeList.innerHTML = "";
  visits.filter(v => !v.signOut).forEach(v => {
    const li = document.createElement("li");
    li.textContent = v.name;
    li.addEventListener("click", () => { nameInput.value = v.name; resetNameClearTimer(); });
    activeList.appendChild(li);
  });
}

/* ------------------- Passcode / Export ------------------- */
function requestExport() {
  pendingAction = "export";
  openModal("passcodeModal");
  document.getElementById("passcodeInput").value = "";
  document.getElementById("passcodeInput").focus();
}

function checkPasscode() {
  const enteredPasscode = document.getElementById("passcodeInput").value;
  if (enteredPasscode !== "1234") {
    alert("Incorrect passcode.");
    document.getElementById("passcodeInput").value = "";
    document.getElementById("passcodeInput").focus();
    return;
  }
  closeModal("passcodeModal");
  if (pendingAction === "export") exportCSV();
  pendingAction = null;
}

function backupVisits() {
  const backup = { timestamp: Date.now(), data: visits };
  localStorage.setItem("visits_backup", JSON.stringify(backup));
}

function restoreBackupIfRecent() {
  const backupStr = localStorage.getItem("visits_backup");
  if (!backupStr) return;
  const backup = JSON.parse(backupStr);
  const FIVE_MINUTES = 5*60*1000;
  if (Date.now() - backup.timestamp < FIVE_MINUTES) {
    visits = backup.data;
    localStorage.setItem("visits", JSON.stringify(visits));
  } else {
    localStorage.removeItem("visits_backup");
  }
}

function exportCSV() {
  backupVisits();
  let csv = "Name,Sign In,Sign Out\n";
  visits.forEach(v => {
    csv += `${v.name},${formatDate(v.signIn)},${v.signOut ? formatDate(v.signOut) : ""}\n`;
  });

  const now = new Date();
  const timestamp =
    now.getFullYear() + "-" +
    String(now.getMonth()+1).padStart(2,"0") + "-" +
    String(now.getDate()).padStart(2,"0") + "_" +
    String(now.getHours()).padStart(2,"0") + "-" +
    String(now.getMinutes()).padStart(2,"0");
  const filename = `visitors_${timestamp}.csv`;

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);

  openModal("exportConfirmModal");
}

function confirmExport(success) {
  closeModal("exportConfirmModal");
  if (!success) {
    alert("Export cancelled. Data restored from backup if available.");
    restoreBackupIfRecent();
    render();
    return;
  }
  visits = [];
  localStorage.removeItem("visits");
  localStorage.removeItem("visits_backup");
  render();
  alert("Export confirmed. Visitor data has been cleared.");
}

/* ------------------- Auto-Clear Name Input ------------------- */
function resetNameClearTimer() {
  if (nameClearTimeout) clearTimeout(nameClearTimeout);
  nameClearTimeout = setTimeout(() => { nameInput.value = ""; }, 10000);
}
nameInput.addEventListener("input", resetNameClearTimer);
nameInput.addEventListener("focus", resetNameClearTimer);

/* ------------------- Wake Lock ------------------- */
let wakeLock = null;
async function requestWakeLock() {
  try { wakeLock = await navigator.wakeLock.request('screen'); }
  catch(err){ console.error(err); }
}
document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock();

/* ------------------- Fullscreen & Orientation Lock ------------------- */
async function requestFullscreen() {
  const elem = document.documentElement;
  if (elem.requestFullscreen) await elem.requestFullscreen();
  else if (elem.webkitRequestFullscreen) await elem.webkitRequestFullscreen();
  if (screen.orientation && screen.orientation.lock) {
    screen.orientation.lock('portrait').catch(()=>{});
  }
}
window.addEventListener('load', () => {
  if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
    requestFullscreen().catch(()=>{});
  }
});

/* ------------------- Service Worker Registration ------------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => console.log('Service Worker registered with scope:', registration.scope))
      .catch(error => console.log('Service Worker registration failed:', error));
  });
}

/* ------------------- Initialize ------------------- */
restoreBackupIfRecent();
render();
</script>

</body>
</html>
